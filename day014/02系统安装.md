# 系统安装

### 安装程序：anaconda

- 启动：bootloader→kernel→initrd→rootfs→anaconda
- anaconda：tui文本界面，gui图形界面
- MBR：isolinux/boot.cat
- STAGE1:isolinux/isolinux.bin
- 配置文件：isolinux/isolinux.cfg
- 加载内核：isolinux/vmlinuz
- 参数：append initrd=initrd.img ip=IP netmask=NETMASK gateway=GATEWAY dns=DNS vnc vncpassword=PASSWD rescue dd
- 装载根文件，启动anaconda
- 512M内存默认是图形界面 
- tui：ESC 在boot:后输入linux text
- 可以使用光盘，u盘，网络安装，软件仓库可以用网络
- ESC 在boot:后输入linux method可以选择安装方法

### 手工安装过程

- 安装前配置：安装使用语言，键盘类型，安装目标存储器（Basic本地磁盘）
- 安装阶段：
    + 创建分区并格式化（boot 500M swap内存2倍，最大8G，120G硬盘，根10G，var10G，home5G，usr15G）
    + 主机名
    + 网络
    + 时区
    + 密码
    + 普通用户
    + 程序包安装配置
    + BootLoader安装位置
- 首次启动：关闭iptables，selinux，coredump

### kickstart 自动安装

#### 安装引导选项

- ks=cdrom:/PATH/TO/KICKSTART_FILE
- 硬盘：hd:/
- http：http://
- ftp：ftp://
- kickstart文件可以根据/root/anaconda-ks.cfg修改

#### kickstart文件

- 包括命令段，程序包段，脚本段

##### 命令段

- 必备：
    + 认证方式：authconfig --enableshadow --passalgo=sha512
    + bootloader位置：bootloader --location=mbr --dirverorder=sda --append="crashkernel=auto rhgb quiet"
    + 键盘：keyboard us 美式
    + 语言：lang en_US.UTF-8
    + 清空mbr：zerombr
    + 清除分区：clearpart --all
    + boot分区：part /boot --fstype=ext4 --size=500
    + pv分区：part pv.008002 --size=51200
    + 卷组：volgroup myvg --pesize=4096 pv.008002
    + lv：logvol / --fstype=ext4 --size=10240 myvg
    + 密码：rootpw --iscrypted （使用openssl passwd -1 -salt \`openssl rand -hex 4`生成）
    + 时区：timezone Asiz/Shanghai
- 可选：
    + install：或upgrade 安装或升级
    + img文件：url url=http://PATH 或cdrom 
    + 文本：text，默认gui
    + 网络：network --onboot yes --device eth0 --bootproto dhcp --noipv6
    + 防火墙：firewall --disabled
    + selinux：selinux --disabled
    + 安装后命令：halt poweroff reboot
    + repo源：repo --name="CentOS" --baseurl=cdrom:sr0 --cost=100
##### 程序包段
```
%package
@group_name
package
-package
%end
```

##### 脚本段
+ %pre：安装前脚本
+ %post：安装后脚本

#### 制作kickstart文件

- 使用system-config-kickstart 图形工具生成ks.cfg
- 使用ksvalidator验证ks文件的有效性

#### 制作启动iso

- 将源系统的isolinux文件夹和ks文件拷贝到myboot
- 修改配置文件 isolinux.cfg timeout=3 ks=cdrom:/ks.cfg
- 使用mkisofs制作iso

```
[root@centos6-mould myboot]# cat ks.cfg
# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
text
url --url=http://mirrors.aliyun.com/centos/6.9/os/x86_64/
lang en_US.UTF-8
keyboard us
network --onboot yes --device eth0 --bootproto dhcp --noipv6
rootpw --iscrypted $6$7Qqmg6dcGcdJctX3$1pOxPQQaczPgnVS2DxM9OX728VAqtg4Nq5NbXbKDlcyVJClmPMbLMBxhWYJfz9WsSym3toubAEpFI5k8ifjzP0
firewall --disabled
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone Asia/Shanghai
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
zerombr
clearpart --all

part /boot --fstype=ext4 --asprimary --size=500
part swap --asprimary --size=1024
part / --fstype=ext4 --grow --asprimary --size=200


repo --name="CentOS" --baseurl=http://mirrors.aliyun.com/centos/6.9/os/x86_64/ --cost=100

%packages
@core
@server-policy
@workstation-policy
@Base
@Development tools
%end
[root@centos6-mould myboot]# chmod u+w isolinux/ -R
[root@centos6-mould myboot]# mkisofs -R -J -T -v --no-emul-boot --boot-load-size 4 --boot-info-table -V "centos 6 boot x86_64" -c isolinux/boot.cat -b isolinux/isolinux.bin -o /root/boot.iso myboot
```

